<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Player - Streamify</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <style>
    body { background-color: #111; color: white; }
    .show-banner img { max-height: 480px; object-fit: cover; width: 100%; border-radius: 12px; }
    .episode-list { overflow-x: auto; display: flex; gap: 1rem; padding: 1rem 0; }
    .episode-card { cursor: pointer; width: 240px; flex: 0 0 auto; }
    .episode-card img { width: 100%; height: 140px; object-fit: cover; border-radius: 6px; }
    .episode-card.active { outline: 2px solid #0dcaf0; }
    .controls-panel { margin-top: 1rem; }
    .controls-panel select { background: #222; color: white; border: 1px solid #555; padding: 0.4rem; border-radius: 6px; }
	#episodeList {
    display: flex;
    overflow-x: auto;
    gap: 1rem;
    padding: 0.5rem 0;
    scrollbar-width: none;
  }
  #episodeList::-webkit-scrollbar {
    display: none;
  }
  #viewAllModal::-webkit-scrollbar {
    display: none;
  }
  #allEpisodesList::-webkit-scrollbar {
    display: none;
  }
  #allEpisodesList .card {
    display: flex;
    flex-direction: row;
    gap: 1rem;
    align-items: center;
    padding: 0.5rem;
    background-color: #1c1c1c;
    border: none;
    border-radius: 0.5rem;
  }
  #allEpisodesList .card img {
    width: 100px;
    height: auto;
    border-radius: 0.25rem;
    object-fit: cover;
  }
  #allEpisodesList .card-body {
    padding: 0;
    flex-grow: 1;
  }
  #allEpisodesList .card-title {
    font-size: 0.9rem;
    margin-bottom: 0.25rem;
    font-weight: bold;
    color: #fff;
  }
  #allEpisodesList .card-text {
    font-size: 0.75rem;
    color: #aaa;
  }
  #allEpisodesList .episode-duration {
    font-size: 0.75rem;
    color: #ccc;
    white-space: nowrap;
    margin-left: auto;
  }
	
  </style>
</head>
<body>
  <div class="container py-4">
<div class="d-flex justify-content-between align-items-center mb-3">
  <button onclick="goBack()" class="btn btn-outline-light btn-sm">&#8592; Back</button>
</div>

<div id="showDetails" class="mb-4">
  <div class="row g-4">
    <div class="col-md-4">
      <img id="showPoster" src="" class="img-fluid rounded" alt="Show poster">
    </div>
    <div class="col-md-8 text-white">
      <h2 id="showTitle"></h2>
      <div class="d-flex flex-wrap align-items-center gap-2 mb-2 small">
        <span id="showEpisodes" class="badge bg-secondary"></span>
        <span id="showAge" class="badge bg-warning text-dark"></span>
        <span id="showYear" class="text-muted"></span>
        <span id="showLangs" class="text-info"></span>
      </div>
      <div id="showGenres" class="text-muted mb-2 small"></div>
      <div id="showContentDesc" class="text-muted mb-2 small"></div>
      <p id="showDesc" class="small"></p>
    </div>
  </div>
</div>
<div>
  <div class="d-flex justify-content-between align-items-center">
    <h5>Episodes</h5>
    <button id="viewAllBtn" class="btn btn-sm btn-outline-light">View All</button>
  </div>
  <div id="episodeNav" class="d-flex align-items-center gap-2 mb-2">
    <button id="prevEp" class="btn btn-sm btn-secondary">&lt;</button>
    <div id="episodeList" class="episode-list flex-grow-1"></div>
    <button id="nextEp" class="btn btn-sm btn-secondary">&gt;</button>
  </div>
</div>

<div id="viewAllModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); overflow-y: auto; z-index: 9999; display: none; padding: 1rem; scrollbar-width: none;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">All Episodes</h5>
    <button id="closeViewAll" class="btn btn-outline-light btn-sm">Close</button>
  </div>
  <div id="allEpisodesList" class="d-flex flex-column gap-2" style="scrollbar-width: none;"></div>
</div>
    <div id="playerSection" class="mt-4">
      <h5 id="episodeTitle"></h5>
      <video id="videoPlayer" controls class="w-100 rounded" style="max-height: 480px; background: black;" poster=""></video>
      <div class="controls-panel d-flex gap-3 mt-3">
        <div>
          <label>Resolution:</label>
          <select id="qualitySelect"></select>
        </div>
        <div>
          <label>Audio:</label>
          <select id="audioSelect"></select>
        </div>
        <div>
          <label>Subtitles:</label>
          <select id="subtitleSelect"></select>
        </div>
      </div>
    </div>
  </div>
  
<script>
  document.getElementById('viewAllBtn').onclick = () => {
    document.getElementById('viewAllModal').style.display = 'block';
  };
  document.getElementById('closeViewAll').onclick = () => {
    document.getElementById('viewAllModal').style.display = 'none';
  };

  const episodeList = document.getElementById('episodeList');
  const prevBtn = document.getElementById('prevEp');
  const nextBtn = document.getElementById('nextEp');

  prevBtn.onclick = () => {
    episodeList.scrollBy({ left: -episodeList.clientWidth, behavior: 'smooth' });
  };

  nextBtn.onclick = () => {
    episodeList.scrollBy({ left: episodeList.clientWidth, behavior: 'smooth' });
  };
</script>

  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const showId = urlParams.get('id');

    fetch('recommended_shows.json')
      .then(res => res.json())
      .then(data => {
        const show = data.find(s => s.id === showId);
        if (!show) return;

        renderShowDetails(show);
        renderEpisodes(show);
      });
	  
	function formatDuration(seconds) {
    const min = Math.floor(seconds / 60);
    const sec = seconds % 60;
    return `${min}:${sec.toString().padStart(2, '0')}`;
  }
  

    function renderShowDetails(show) {
    const ep = show.items.find(i => i.type === 'episode');
    const container = ep.container?.container;
    const poster = container?.imageInfo?.find(i => i.type === 'bigpic')?.url || '';
    const title = container?.title || ep.title;
    const description = show.description || ep.description || '';
    const genres = show.genres?.join(', ') || '';
    const contentDesc = (show.contentDescriptors || []).join(', ');
    const ageRating = show.ageRating || '';
    const year = show.releaseDate || '';
    const lang = (show.languages || []).join(', ');
    const epCount = show.items.filter(i => i.type === 'episode').length;

    document.getElementById('showPoster').src = poster;
    document.getElementById('showPoster').alt = title;
    document.getElementById('showTitle').textContent = title;
    document.getElementById('showDesc').textContent = description;
    document.getElementById('showGenres').textContent = genres ? `Genre: ${genres}` : '';
    document.getElementById('showContentDesc').textContent = contentDesc ? `Content Descriptor: ${contentDesc}` : '';
    document.getElementById('showAge').textContent = ageRating;
    document.getElementById('showYear').textContent = year;
    document.getElementById('showLangs').textContent = lang;
    document.getElementById('showEpisodes').textContent = `${epCount} Episodes`;
  }

  function goBack() {
    const scrollY = sessionStorage.getItem('scrollY');
    window.history.back();
    if (scrollY) {
      setTimeout(() => window.scrollTo(0, parseInt(scrollY)), 100);
    }
  }

  if (!sessionStorage.getItem('scrollY')) {
    sessionStorage.setItem('scrollY', window.scrollY);
  }

    function renderEpisodes(show) {
    const list = document.getElementById('episodeList');
    const allList = document.getElementById('allEpisodesList');
    const player = document.getElementById('videoPlayer');
    const epTitle = document.getElementById('episodeTitle');
    const qualitySelect = document.getElementById('qualitySelect');
    const audioSelect = document.getElementById('audioSelect');
    const subtitleSelect = document.getElementById('subtitleSelect');

    const episodes = show.items.filter(i => i.type === 'episode').sort((a, b) => a.sequence - b.sequence);

    let hls;

    function loadEpisode(ep, card) {
      document.querySelectorAll('.episode-card').forEach(el => el.classList.remove('active'));
      if (card) card.classList.add('active');

      epTitle.innerText = ep.title;
      const hlsUrl = ep.stream?.hls?.high;
      const thumb = ep.imageInfo?.find(i => i.type === 'bigpic')?.url || '';
      if (!hlsUrl) {
        alert('No valid HLS URL found for this episode.');
        return;
      }
      if (hls) {
        hls.destroy();
        hls = null;
      }
      if (Hls.isSupported()) {
        hls = new Hls({ enableWebVTT: true });
        hls.attachMedia(player);
        hls.loadSource(hlsUrl);
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          player.play();
          qualitySelect.innerHTML = '';
          hls.levels.forEach((level, i) => {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `${level.height}p`;
            qualitySelect.appendChild(option);
          });
          qualitySelect.onchange = () => {
            hls.currentLevel = parseInt(qualitySelect.value);
          };
          hls.currentLevel = -1;
        });
        hls.on(Hls.Events.AUDIO_TRACKS_UPDATED, () => {
          audioSelect.innerHTML = '';
          const audioMap = { 'ta': 'Tamil', 'te': 'Telugu', 'hi': 'Hindi', 'ko': 'Korean', 'zh': 'Chinese', 'tr': 'Turkish', 'bho': 'Bhojpuri', 'zh_tw': 'Taiwanese', 'it': 'Italian', 'es': 'Spanish', 'pt': 'Portuguese', 'en': 'English', 'ja': 'Japanese', 'th': 'Thai' };
          let defaultIndex = 0;
          if (hls.audioTracks.length === 1) {
            const option = document.createElement('option');
            option.value = 0;
            option.textContent = 'Tamil';
            audioSelect.appendChild(option);
          } else {
            hls.audioTracks.forEach((track, i) => {
              const lang = track.lang?.toLowerCase();
              const label = audioMap[lang] || track.name || lang || 'Track ' + (i + 1);
              const option = document.createElement('option');
              option.value = i;
              option.textContent = label;
              audioSelect.appendChild(option);
              if (lang === 'ta') defaultIndex = i;
            });
          }
          audioSelect.onchange = () => {
            hls.audioTrack = parseInt(audioSelect.value);
          };
          hls.audioTrack = defaultIndex;
          audioSelect.value = defaultIndex;
        });
        hls.on(Hls.Events.SUBTITLE_TRACKS_UPDATED, () => {
          subtitleSelect.innerHTML = '';
          const noneOption = document.createElement('option');
          noneOption.value = -1;
          noneOption.textContent = 'None';
          subtitleSelect.appendChild(noneOption);
          hls.subtitleTracks.forEach((track, i) => {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = 'English';
            subtitleSelect.appendChild(option);
          });
          subtitleSelect.onchange = () => {
            hls.subtitleTrack = parseInt(subtitleSelect.value);
          };
          hls.subtitleTrack = -1;
          subtitleSelect.value = -1;
        });
      } else if (player.canPlayType('application/vnd.apple.mpegurl')) {
        player.src = hlsUrl;
        player.load();
        player.play();
      } else {
        alert('This browser does not support HLS playback.');
      }
      player.poster = thumb;
    }

    episodes.forEach((ep, index) => {
      const thumb = ep.imageInfo?.find(i => i.type === 'bigpic')?.url || '';
      const card = document.createElement('div');
      card.className = 'episode-card';
      card.innerHTML = `<img src="${thumb}" alt="${ep.title}"><p class="text-white small mt-2">${ep.title}</p>`;
      card.onclick = () => loadEpisode(ep, card);
      list.appendChild(card);

      const title = `S${ep.container?.title?.match(/\d+/)?.[0] || 1}E${ep.sequence}  ${ep.title}`;
      const description = ep.description || '';
      const duration = formatDuration(parseInt(ep.duration || 0));

      const fullCard = document.createElement('div');
      fullCard.className = 'card';
      fullCard.style.cursor = 'pointer';
      fullCard.innerHTML = `
        <img src="${thumb}" alt="${ep.title}">
        <div class="card-body">
          <div class="d-flex align-items-start justify-content-between">
            <div>
              <div class="card-title">${title}</div>
              <div class="card-text">${description}</div>
            </div>
            <div class="episode-duration">${duration}</div>
          </div>
        </div>
      `;
      fullCard.onclick = () => {
        document.getElementById('viewAllModal').style.display = 'none';
        loadEpisode(ep);
      };
      allList.appendChild(fullCard);

      if (index === 0) card.click();
    });
  }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
