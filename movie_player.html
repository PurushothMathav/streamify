<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Player - Streamify</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #000;
      color: #fff;
      margin: 0;
    }
    #videoPlayer {
      width: 100%;
      max-height: 70vh;
      background: black;
    }
    .controls {
      margin-top: 10px;
    }
    select {
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <div class="container py-3">
    <h3 id="movieTitle">Loading...</h3>
    <video id="videoPlayer" controls autoplay></video>
    <div class="controls">
      <label>Quality:</label>
      <select id="qualitySelect">
        <option value="-1">Auto</option>
      </select>

      <label>Audio:</label>
      <select id="audioSelect"></select>

      <label>Subtitle:</label>
      <select id="subtitleSelect">
        <option value="">None</option>
      </select>
    </div>
  </div>

  <script>
    const movie = JSON.parse(localStorage.getItem('selectedMovie'));
    document.getElementById('movieTitle').textContent = movie.title;

    const video = document.getElementById('videoPlayer');
    const qualitySelect = document.getElementById('qualitySelect');
    const audioSelect = document.getElementById('audioSelect');
    const subtitleSelect = document.getElementById('subtitleSelect');

    const masterUrl = movie.stream?.thirdParty?.hlsUrl || movie.stream?.hls?.high;

    let currentHls;
    function loadMasterStream(hlsUrl) {
      if (!hlsUrl) {
        alert("No video stream available.");
        return;
      }

      if (currentHls) currentHls.destroy();

      if (Hls.isSupported()) {
        const hls = new Hls({
          defaultAudioCodec: 'mp4a.40.2',
        });
        hls.loadSource(hlsUrl);
        hls.attachMedia(video);
        currentHls = hls;

        hls.on(Hls.Events.MANIFEST_PARSED, () => {
          video.play();
          hls.subtitleTrack = -1; // disable subtitle by default
        });

        hls.on(Hls.Events.LEVEL_LOADED, () => {
          qualitySelect.innerHTML = '<option value="-1">Auto</option>';
          let defaultSet = false;

          hls.levels.forEach((level, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.text = `${level.height}p`;
            if (level.height === 720 && !defaultSet) {
              opt.selected = true;
              hls.currentLevel = i;
              defaultSet = true;
            }
            qualitySelect.appendChild(opt);
          });
        });

        qualitySelect.addEventListener('change', () => {
          if (currentHls) {
            const val = parseInt(qualitySelect.value);
            currentHls.currentLevel = val;
          }
        });

        hls.on(Hls.Events.AUDIO_TRACKS_UPDATED, (event, data) => {
          audioSelect.innerHTML = '';
          let taIndex = -1;
          let uniqueTracks = {};

          data.audioTracks.forEach((track, index) => {
            if (!uniqueTracks[track.url]) {
              uniqueTracks[track.url] = true;
              const opt = document.createElement('option');
              opt.value = index;
              opt.text = `${track.name || 'Track'} (${track.lang || 'und'})`;
              if (track.lang === 'ta') taIndex = index;
              audioSelect.appendChild(opt);
            }
          });

          if (taIndex >= 0) {
            audioSelect.value = taIndex;
            hls.audioTrack = taIndex;
          } else if (audioSelect.options.length > 0) {
            audioSelect.value = 0;
            hls.audioTrack = 0;
          }
        });

        audioSelect.addEventListener('change', () => {
          if (currentHls) {
            currentHls.audioTrack = parseInt(audioSelect.value);
          }
        });

        hls.on(Hls.Events.SUBTITLE_TRACKS_UPDATED, (event, data) => {
          subtitleSelect.innerHTML = '<option value="">None</option>';
          data.subtitleTracks.forEach((track, i) => {
            const opt = document.createElement('option');
            opt.value = i;
            opt.text = track.name || `Subtitle ${i + 1}`;
            subtitleSelect.appendChild(opt);
          });
          subtitleSelect.value = "";
          hls.subtitleTrack = -1;
        });

        subtitleSelect.addEventListener('change', () => {
          if (currentHls) {
            const val = subtitleSelect.value;
            currentHls.subtitleTrack = val === "" ? -1 : parseInt(val);
          }
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = hlsUrl;
      }
    }

    loadMasterStream(masterUrl);
  </script>
</body>
</html>